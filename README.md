-----

# æ›¼-è‚¯å¾·çˆ¾ (Mann-Kendall) è¶¨å‹¢æª¢å®š C èªžè¨€å¯¦ä½œ

ä½¿ç”¨ C èªžè¨€å¯¦ç¾çš„æ›¼-è‚¯å¾·çˆ¾ (Mann-Kendall, MK) è¶¨å‹¢æª¢å®šã€‚MK æª¢å®šæ˜¯ä¸€ç¨®éžåƒæ•¸çµ±è¨ˆæ–¹æ³•ï¼Œå»£æ³›æ‡‰ç”¨æ–¼æ™‚é–“åºåˆ—åˆ†æžï¼Œç”¨ä»¥åˆ¤æ–·æ•¸æ“šæ˜¯å¦å­˜åœ¨å–®èª¿çš„ä¸Šå‡æˆ–ä¸‹é™è¶¨å‹¢ã€‚

æœ¬å°ˆæ¡ˆçš„æ ¸å¿ƒæ˜¯ `mann_kendall()` å‡½å¼ï¼Œå®ƒèƒ½è¨ˆç®—å‡ºè¶¨å‹¢çš„ S çµ±è¨ˆé‡ã€è®Šç•°æ•¸ Var(S) ä»¥åŠæ¨™æº–åŒ–çš„ Z çµ±è¨ˆé‡ã€‚æ­¤å¯¦ä½œç‰¹åˆ¥é‡å° S çµ±è¨ˆé‡çš„è¨ˆç®—éŽç¨‹ï¼ŒæŽ¡ç”¨äº† **AVX2 SIMD å…§éƒ¨æŒ‡ä»¤ (Intrinsics)** é€²è¡Œäº†æ•ˆèƒ½å„ªåŒ–ï¼Œå¤§å¹…æå‡äº†å¤§è¦æ¨¡æ•¸æ“šçš„é‹ç®—é€Ÿåº¦ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

- **æ¨™æº– MK æª¢å®š**ï¼šå®Œæ•´å¯¦ç¾ Mann-Kendall è¶¨å‹¢æª¢å®šï¼Œè¨ˆç®— Sã€Var(S) èˆ‡ Z çµ±è¨ˆé‡ã€‚
- **è™•ç†é‡è¤‡å€¼ (Ties)**ï¼šåœ¨è¨ˆç®—è®Šç•°æ•¸æ™‚ï¼Œèƒ½æº–ç¢ºåœ°è™•ç†æ•¸æ“šä¸­çš„é‡è¤‡å€¼ï¼ˆTied Valuesï¼‰ï¼Œç¢ºä¿çµ±è¨ˆçµæžœçš„æº–ç¢ºæ€§ã€‚
- **AVX2 æ•ˆèƒ½å„ªåŒ–**ï¼šåˆ©ç”¨ `_mm256` ç³»åˆ—æŒ‡ä»¤å¹³è¡Œè™•ç† 8 å€‹æµ®é»žæ•¸ï¼ŒåŠ é€Ÿ S çµ±è¨ˆé‡çš„è¨ˆç®—ï¼Œé©åˆè™•ç†å¤§è¦æ¨¡æ•¸æ“šé›†ã€‚
- **è¨˜æ†¶é«”å°é½Š**ï¼šç¯„ä¾‹ç¨‹å¼ä½¿ç”¨ `posix_memalign` ç¢ºä¿è¼¸å…¥æ•¸æ“šçš„è¨˜æ†¶é«”ä½å€ç‚º 32 ä½å…ƒçµ„å°é½Šï¼Œæ»¿è¶³ AVX2 æŒ‡ä»¤é›†çš„è¦æ±‚ã€‚
- **è¶¨å‹¢è§£è®€**ï¼šæä¾› `interpret_result()` è¼”åŠ©å‡½å¼ï¼Œå¯æ ¹æ“š Z çµ±è¨ˆé‡èˆ‡é¡¯è‘—æ€§æ°´å¹³ (alpha)ï¼Œç›´æŽ¥åˆ¤æ–·è¶¨å‹¢çš„é¡¯è‘—æ€§ï¼ˆä¸Šå‡ã€ä¸‹é™æˆ–ç„¡è¶¨å‹¢ï¼‰ã€‚

## ðŸ“ æª”æ¡ˆçµæ§‹

- **`main.c`**: ç¯„ä¾‹ä¸»ç¨‹å¼ã€‚åŒ…å«äº†ä¸‰å€‹æ ¸å¿ƒæ¸¬è©¦æ¡ˆä¾‹ï¼Œåˆ†åˆ¥å°ã€Œä¸Šå‡è¶¨å‹¢ã€ã€ã€Œä¸‹é™è¶¨å‹¢ã€åŠã€Œç„¡è¶¨å‹¢ã€çš„åˆæˆæ•¸æ“šé€²è¡Œæª¢å®šï¼Œä¸¦å±•ç¤ºå¦‚ä½•è§£è®€çµæžœã€‚
- **`mann_kendall.h`**: å‡½å¼åº«çš„é ­æ–‡ä»¶ã€‚å®šç¾©äº† `mann_kendall` å‡½å¼çš„ API æŽ¥å£ã€‚
- **`mann_kendall.c`**: Mann-Kendall æª¢å®šçš„å…·é«”å¯¦ç¾ã€‚åŒ…å«äº† S çµ±è¨ˆé‡çš„ AVX2 å„ªåŒ–æ¼”ç®—æ³•ã€é‡è¤‡å€¼çš„è™•ç†é‚è¼¯ï¼Œä»¥åŠ Z çµ±è¨ˆé‡çš„è¨ˆç®—ã€‚

## âš™ï¸ æ ¸å¿ƒæ¼”ç®—æ³•èªªæ˜Ž

æœ¬å°ˆæ¡ˆå¯¦ç¾çš„ Mann-Kendall æª¢å®šï¼Œå…¶ç›®æ¨™æ˜¯è©•ä¼°æ™‚é–“åºåˆ—æ•¸æ“š `data` ä¸­çš„å–®èª¿è¶¨å‹¢ã€‚

1.  **è¨ˆç®— S çµ±è¨ˆé‡**ï¼š
    -   S çµ±è¨ˆé‡æ˜¯æ‰€æœ‰ `(data[j], data[i])` (å…¶ä¸­ j > i) é…å°ç¬¦è™Ÿçš„ç¸½å’Œã€‚
    -   `S = Î£ sign(data[j] - data[i])`
    -   å…¶ä¸­ `sign(x)` åœ¨ x > 0 æ™‚ç‚º +1ï¼Œx < 0 æ™‚ç‚º -1ï¼Œx = 0 æ™‚ç‚º 0ã€‚
    -   ä¸€å€‹å¤§çš„æ­£ S å€¼è¡¨ç¤ºä¸Šå‡è¶¨å‹¢ï¼Œä¸€å€‹å¤§çš„è²  S å€¼è¡¨ç¤ºä¸‹é™è¶¨å‹¢ã€‚

2.  **è¨ˆç®— S çš„è®Šç•°æ•¸ Var(S)**ï¼š
    -   åœ¨æ²’æœ‰é‡è¤‡å€¼çš„æƒ…æ³ä¸‹ï¼Œå…¬å¼ç‚º `Var(S) = [n(n-1)(2n+5)] / 18`ã€‚
    -   ç•¶æ•¸æ“šä¸­å­˜åœ¨é‡è¤‡å€¼æ™‚ï¼Œéœ€è¦å°å…¬å¼é€²è¡Œä¿®æ­£ã€‚æœ¬å¯¦ä½œé€šéŽå°æ•¸æ“šæŽ’åºï¼Œæ‰¾å‡ºæ¯å€‹é‡è¤‡å€¼ç¾¤çµ„ (`tie_count`)ï¼Œä¸¦è¨ˆç®—ä¿®æ­£é … `tie_term`ã€‚
    -   ä¿®æ­£å¾Œçš„å…¬å¼ç‚º `Var(S) = [n(n-1)(2n+5) - Î£ t(t-1)(2t+5)] / 18`ï¼Œå…¶ä¸­ t æ˜¯æ¯å€‹é‡è¤‡å€¼ç¾¤çµ„çš„å¤§å°ã€‚

3.  **è¨ˆç®— Z çµ±è¨ˆé‡ (æ¨™æº–åŒ–)**ï¼š
    -   Z çµ±è¨ˆé‡å°‡ S è½‰æ›ç‚ºæ¨™æº–å¸¸æ…‹åˆ†ä½ˆï¼Œæ–¹ä¾¿é€²è¡Œå‡è¨­æª¢å®šã€‚
    -   å…¬å¼ç‚ºï¼š
        -   è‹¥ S > 0, `Z = (S - 1) / sqrt(Var(S))`
        -   è‹¥ S < 0, `Z = (S + 1) / sqrt(Var(S))`
        -   è‹¥ S = 0, `Z = 0`
    -   `+1` æˆ– `-1` æ˜¯é€£çºŒæ€§æ ¡æ­£é …ã€‚

## ðŸš€ æ•ˆèƒ½å„ªåŒ–æŠ€è¡“

æœ¬å°ˆæ¡ˆçš„æ ¸å¿ƒæ•ˆèƒ½å„ªåŒ–åœ¨æ–¼ S çµ±è¨ˆé‡çš„è¨ˆç®—ï¼Œå®ƒå…·æœ‰ $O(n^2)$ çš„æ™‚é–“è¤‡é›œåº¦ã€‚æˆ‘å€‘ä½¿ç”¨ SIMD (å–®æŒ‡ä»¤å¤šæ•¸æ“šæµ) æŠ€è¡“ä¾†åŠ é€Ÿé€™å€‹éŽç¨‹ã€‚

-   **AVX2 SIMD å…§éƒ¨æŒ‡ä»¤**ï¼š
    -   åˆ©ç”¨ `__m256` é¡žåž‹ï¼Œä¸€æ¬¡å¯ä»¥è¼‰å…¥ 8 å€‹ 32 ä½å…ƒæµ®é»žæ•¸ã€‚
    -   åœ¨é›™é‡è¿´åœˆä¸­ï¼Œå…§å±¤è¿´åœˆä½¿ç”¨ `_mm256_load_ps` ä¸€æ¬¡è®€å– 8 å€‹ `data[j]` å€¼ã€‚
    -   ä½¿ç”¨ `_mm256_cmp_ps` æŒ‡ä»¤ï¼Œå°‡é€™ 8 å€‹å€¼èˆ‡ `data[i]` é€²è¡Œå¹³è¡Œæ¯”è¼ƒï¼ŒåŒæ™‚ç”¢ç”Ÿå¤§æ–¼ (`_CMP_GT_OQ`) å’Œå°æ–¼ (`_CMP_LT_OQ`) çš„é®ç½© (mask)ã€‚
    -   `_mm256_movemask_ps` å°‡æ¯”è¼ƒçµæžœçš„é®ç½©è½‰æ›ç‚ºä¸€å€‹æ•´æ•¸ã€‚
    -   æœ€å¾Œï¼Œä½¿ç”¨ `__builtin_popcount` å…§å»ºå‡½å¼å¿«é€Ÿè¨ˆç®—æ•´æ•¸ä¸­ä½å…ƒç‚º 1 çš„æ•¸é‡ï¼Œé€™ç­‰åŒæ–¼ä¸€æ¬¡æ€§çµ±è¨ˆå‡º 8 æ¬¡æ¯”è¼ƒä¸­å¤§æ–¼æˆ–å°æ–¼ `data[i]` çš„å€‹æ•¸ï¼Œä¸¦ç´¯åŠ åˆ° `s_val` ä¸­ã€‚
-   **è¨˜æ†¶é«”å°é½Š (Memory Alignment)**ï¼š
    -   AVX2 çš„ `_mm256_load_ps` æŒ‡ä»¤è¦æ±‚è¨˜æ†¶é«”ä½å€æ˜¯ 32 ä½å…ƒçµ„å°é½Šçš„ï¼Œå¦å‰‡æœƒå°Žè‡´æ•ˆèƒ½ä¸‹é™æˆ–ç¨‹å¼å´©æ½°ã€‚
    -   `main.c` ä¸­çš„ `align_malloc` å‡½å¼ä½¿ç”¨ `posix_memalign` ä¾†åˆ†é…å°é½Šçš„è¨˜æ†¶é«”ï¼Œç¢ºä¿äº† AVX2 æŒ‡ä»¤èƒ½å¤ é«˜æ•ˆåŸ·è¡Œã€‚

## ðŸ› ï¸ å¦‚ä½•ç·¨è­¯èˆ‡åŸ·è¡Œ

æœ¬å°ˆæ¡ˆç¨‹å¼ç¢¼ä½¿ç”¨äº† AVX2 æŒ‡ä»¤é›†èˆ‡ `math.h`ï¼Œå› æ­¤åœ¨ç·¨è­¯æ™‚éœ€è¦é–‹å•Ÿå°æ‡‰çš„æ——æ¨™ä¸¦é€£çµæ•¸å­¸å‡½å¼åº«ã€‚

1.  **ç·¨è­¯æŒ‡ä»¤**ï¼š
    æ‰“é–‹çµ‚ç«¯æ©Ÿï¼Œä¸¦ä½¿ç”¨ `gcc` æˆ– `clang` é€²è¡Œç·¨è­¯ã€‚`-lm` ç”¨æ–¼é€£çµæ•¸å­¸åº«ï¼Œ`-mavx2` ç”¨æ–¼å•Ÿç”¨ AVX2 æŒ‡ä»¤é›†ã€‚

    ```bash
    gcc main.c mann_kendall.c -o mk_demo -O2 -lm -mavx2
    ```

2.  **åŸ·è¡Œ**ï¼š
    ç·¨è­¯æˆåŠŸå¾Œï¼Œæœƒç”Ÿæˆåç‚º `mk_demo` çš„åŸ·è¡Œæª”ã€‚

    ```bash
    ./mk_demo
    ```

3.  **é æœŸè¼¸å‡º**ï¼š
    åŸ·è¡Œå¾Œï¼Œå°‡æœƒçœ‹åˆ°ä¸‰å€‹æ¸¬è©¦æ¡ˆä¾‹çš„çµæžœï¼Œå±•ç¤ºäº†ä¸åŒè¶¨å‹¢ä¸‹çš„çµ±è¨ˆæ•¸æ“šã€‚
    *(è¨»ï¼šç¯„ä¾‹ç¨‹å¼çš„è¿´åœˆå¯«æ³•æœƒç”¢ç”Ÿå¤§é‡è¼¸å‡ºï¼Œæ­¤è™•åƒ…å±•ç¤ºå„æ¸¬è©¦æœ€å¾Œä¸€æ¬¡çš„ä»£è¡¨æ€§çµæžœ)*

    ```
    S = 498514
    Var(S) = 1666665024.0000
    Z = 12.2173

    Under the alpha = 0.05 (cirtical value â‰ˆ 1.960):
    Reject Null Hypothesis, Data exists 'trending up'


    S = -498522
    Var(S) = 1666665024.0000
    Z = -12.2175

    Under the alpha = 0.05 (cirtical value â‰ˆ 1.960):
    Reject Null Hypothesis, Data exists 'trending down'


    S = -2140
    Var(S) = 1666665024.0000
    Z = -0.0522

    Under the alpha = 0.05 (cirtical value â‰ˆ 1.960):
    Not reject Null Hypothesis, Data exists 'no trending'
    ```

## ðŸ“š API æ–‡ä»¶

### `void mann_kendall(const float* data, size_t n, long long* S, float* var_S, float* Z)`

åŸ·è¡Œ Mann-Kendall è¶¨å‹¢æª¢å®šã€‚

-   **åƒæ•¸**:
    -   `const float* data`: æŒ‡å‘æ™‚é–“åºåˆ—æ•¸æ“šçš„æŒ‡æ¨™ (å»ºè­°ç‚º 32 ä½å…ƒçµ„å°é½Š)ã€‚
    -   `size_t n`: æ•¸æ“šé»žçš„æ•¸é‡ã€‚
    -   `long long* S`: (è¼¸å‡º) ç”¨æ–¼å„²å­˜ S çµ±è¨ˆé‡çš„æŒ‡æ¨™ã€‚
    -   `float* var_S`: (è¼¸å‡º) ç”¨æ–¼å„²å­˜ Var(S) è®Šç•°æ•¸çš„æŒ‡æ¨™ã€‚
    -   `float* Z`: (è¼¸å‡º) ç”¨æ–¼å„²å­˜ Z çµ±è¨ˆé‡çš„æŒ‡æ¨™ã€‚
-   **å›žå‚³å€¼**:
    -   ç„¡ã€‚è¨ˆç®—çµæžœæœƒé€éŽå‚³å…¥çš„æŒ‡æ¨™å›žå‚³ã€‚

## ðŸ’¡ ç¯„ä¾‹è§£æž

`main.c` æª”æ¡ˆåŒ…å«ä¸‰å€‹æ¸¬è©¦ï¼Œç”¨æ–¼é©—è­‰ `mann_kendall` åœ¨ä¸åŒæƒ…å¢ƒä¸‹çš„è¡Œç‚ºï¼š

1.  **æ¸¬è©¦ 1 (ä¸Šå‡è¶¨å‹¢)**ï¼š
    -   æ•¸æ“šç”Ÿæˆå…¬å¼ç‚º `data[i] = 0.1 * i + random_noise`ã€‚
    -   é€™çµ„æ•¸æ“šå…·æœ‰æ˜Žç¢ºçš„ç·šæ€§ä¸Šå‡è¶¨å‹¢ï¼Œå¤–åŠ å°‘é‡éš¨æ©Ÿé›œè¨Šã€‚
    -   é æœŸçµæžœï¼šS çµ±è¨ˆé‡ç‚ºä¸€å€‹å¾ˆå¤§çš„æ­£æ•¸ï¼ŒZ å€¼é å¤§æ–¼ 1.96 (åœ¨ alpha=0.05 æ™‚)ï¼Œçµè«–ç‚ºã€Œå­˜åœ¨é¡¯è‘—çš„ä¸Šå‡è¶¨å‹¢ã€ã€‚

2.  **æ¸¬è©¦ 2 (ä¸‹é™è¶¨å‹¢)**ï¼š
    -   æ•¸æ“šç”Ÿæˆå…¬å¼ç‚º `data[i] = -0.1 * i + random_noise`ã€‚
    -   é€™çµ„æ•¸æ“šå…·æœ‰æ˜Žç¢ºçš„ç·šæ€§ä¸‹é™è¶¨å‹¢ã€‚
    -   é æœŸçµæžœï¼šS çµ±è¨ˆé‡ç‚ºä¸€å€‹å¾ˆå¤§çš„è² æ•¸ï¼ŒZ å€¼é å°æ–¼ -1.96ï¼Œçµè«–ç‚ºã€Œå­˜åœ¨é¡¯è‘—çš„ä¸‹é™è¶¨å‹¢ã€ã€‚

3.  **æ¸¬è©¦ 3 (ç„¡è¶¨å‹¢)**ï¼š
    -   æ•¸æ“šç”Ÿæˆå…¬å¼ç‚º `data[i] = random`ã€‚
    -   é€™çµ„æ•¸æ“šå®Œå…¨ç”±éš¨æ©Ÿæ•¸æ§‹æˆï¼Œç†è«–ä¸Šä¸å­˜åœ¨ä»»ä½•è¶¨å‹¢ã€‚
    -   é æœŸçµæžœï¼šS çµ±è¨ˆé‡æŽ¥è¿‘ 0ï¼ŒZ å€¼ä¹ŸæŽ¥è¿‘ 0 (é€šå¸¸åœ¨ -1.96 åˆ° 1.96 ä¹‹é–“)ï¼Œçµè«–ç‚ºã€Œæ²’æœ‰é¡¯è‘—è¶¨å‹¢ã€ã€‚
