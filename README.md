-----

# å‹•æ…‹æ™‚é–“æ‰­æ›² (DTW) C èªè¨€å¯¦ä½œ (å­åºåˆ—åŒ¹é…)

ä½¿ç”¨ C èªè¨€å¯¦ç¾çš„å‹•æ…‹æ™‚é–“æ‰­æ›² (Dynamic Time Warping, DTW) æ¼”ç®—æ³•ã€‚DTW æ˜¯ä¸€ç¨®ç”¨æ–¼è¡¡é‡å…©å€‹æ™‚é–“åºåˆ—ä¹‹é–“ç›¸ä¼¼åº¦çš„ç¶“å…¸æ–¹æ³•ï¼Œç‰¹åˆ¥æ“…é•·è™•ç†åºåˆ—åœ¨æ™‚é–“è»¸ä¸Šå­˜åœ¨ä¼¸ç¸®æˆ–åç§»çš„æƒ…æ³ã€‚

æœ¬å°ˆæ¡ˆçš„æ ¸å¿ƒæ˜¯å¯¦ç¾ **å­åºåˆ— DTW (Subsequence DTW)**ï¼Œä¹Ÿç¨±ç‚ºå­åºåˆ—å°é½Š (Subsequence Alignment)ã€‚å®ƒç”¨æ–¼åœ¨ä¸€å€‹è¼ƒé•·çš„ç›®æ¨™åºåˆ— (`trg`) ä¸­ï¼Œæœå°‹ä¸€å€‹è¼ƒçŸ­çš„æŸ¥è©¢åºåˆ— (`src`) çš„æœ€ä½³åŒ¹é…ä½ç½®ã€‚

æ­¤å¯¦ä½œåŒ…å« **Sakoe-Chiba Band** å’Œ **æˆæœ¬é–¥å€¼ (Threshold)** ç­‰å‰ªææŠ€è¡“ï¼Œä»¥æé«˜æœå°‹æ•ˆç‡ï¼Œä¸¦æ¡ç”¨å•Ÿç™¼å¼è¦–çª—æœå°‹ç­–ç•¥ä¾†åŠ é€ŸåŒ¹é…éç¨‹ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

  - **å­åºåˆ—å°é½Š (Subsequence Alignment)**ï¼šæ ¸å¿ƒåŠŸèƒ½ `subsequence_alignment()`ï¼Œåœ¨é•·åºåˆ—ä¸­å°‹æ‰¾çŸ­åºåˆ—çš„æœ€ä½³åŒ¹é…å€æ®µ (start, end) åŠå…¶å°æ‡‰çš„æ‰­æ›²è·é›¢ã€‚
  - **Sakoe-Chiba Band å‰ªæ**ï¼š`DTWConfig` æ”¯æ´è¨­å®š `sakoe_chiba_band` æ¯”ä¾‹ï¼Œå°‡æœå°‹ç¯„åœé™åˆ¶åœ¨å°è§’ç·šå‘¨åœçš„çª„å¸¶å…§ï¼Œå¤§å¹…æ¸›å°‘è¨ˆç®—é‡ã€‚
  - **æˆæœ¬é–¥å€¼ (Threshold) å‰ªæ**ï¼šæ”¯æ´è¨­å®š `threshold`ï¼Œä»»ä½•ç´¯ç©æˆæœ¬è¶…éæ­¤é–¥å€¼çš„æ½›åœ¨è·¯å¾‘éƒ½æœƒè¢«æå‰æ¨æ£„ã€‚
  - **å•Ÿç™¼å¼æœå°‹**ï¼š`subsequence_alignment` æ¡ç”¨æ»‘å‹•è¦–çª—å’Œå•Ÿç™¼å¼æœå°‹ç­–ç•¥ï¼ˆåŒ…æ‹¬ææ—©åœæ­¢ï¼‰ï¼Œåœ¨æ•ˆèƒ½å’Œæº–ç¢ºæ€§ä¹‹é–“å–å¾—å¹³è¡¡ã€‚
  - **C++ ç›¸å®¹**ï¼šé ­æ–‡ä»¶ä½¿ç”¨ `extern "C"` åŒ…è£ï¼Œç¢ºä¿ C++ å°ˆæ¡ˆä¹Ÿèƒ½é †åˆ©å¼•ç”¨ã€‚

## ğŸ“ æª”æ¡ˆçµæ§‹

  - **`main.c`**: ç¯„ä¾‹ä¸»ç¨‹å¼ã€‚åŒ…å«ä¸€ç³»åˆ—å–®å…ƒæ¸¬è©¦ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `subsequence_alignment` å‡½å¼ï¼Œä¸¦æ¶µè“‹äº†å„ç¨®æƒ…å¢ƒï¼ˆå¦‚å®Œç¾åŒ¹é…ã€å‰ªæã€ææ—©åœæ­¢ç­‰ï¼‰ã€‚
  - **`dtw.h`**: å‡½å¼åº«çš„é ­æ–‡ä»¶ã€‚å®šç¾©äº† `DTWConfig`ã€`DTWResult` çµæ§‹é«”ï¼Œä»¥åŠå¤–éƒ¨å¯ç”¨çš„ API æ¥å£ã€‚
  - **`dtw.c`**: DTW æ¼”ç®—æ³•çš„å…·é«”å¯¦ç¾ã€‚åŒ…å«äº†æ ¸å¿ƒçš„ `dtw_distance` æ¼”ç®—æ³•ã€`subsequence_alignment` æœå°‹é‚è¼¯ä»¥åŠè¼”åŠ©å‡½å¼ã€‚

## âš™ï¸ æ ¸å¿ƒæ¼”ç®—æ³•èªªæ˜

æœ¬å°ˆæ¡ˆå¯¦ç¾çš„å­åºåˆ— DTWï¼Œå…¶ç›®æ¨™æ˜¯åœ¨é•·åºåˆ— `trg` ä¸­æ‰¾åˆ°ä¸€å€‹å­åºåˆ— `trg[start...end]`ï¼Œä½¿å…¶èˆ‡çŸ­åºåˆ— `src` çš„ DTW è·é›¢æœ€å°ã€‚

1.  **å»ºç«‹æˆæœ¬çŸ©é™£ (Cost Matrix)**ï¼š
      - å»ºç«‹ä¸€å€‹ `(src_len + 1) x (win_len + 1)` çš„æˆæœ¬çŸ©é™£ `cost`ï¼Œå…¶ä¸­ `win_len` æ˜¯ `trg` ä¸­å¾…åŒ¹é…å­åºåˆ—çš„é•·åº¦ã€‚
2.  **åˆå§‹åŒ– (Subsequence DTW çš„é—œéµ)**ï¼š
      - `cost[0][0] = 0`ã€‚
      - `cost[i][0] = FLT_MAX` (for i \> 0)ï¼šæŸ¥è©¢åºåˆ— `src` å¿…é ˆå®Œæ•´åŒ¹é…ï¼Œä¸èƒ½è·³éé–‹é ­ã€‚
      - `cost[0][j] = 0.0` (for j \> 0)ï¼šç›®æ¨™åºåˆ— `trg` **å¯ä»¥å¾ä»»ä½•ä½ç½®é–‹å§‹åŒ¹é…**ã€‚é€™å°±æ˜¯å­åºåˆ—å°é½Šèˆ‡æ¨™æº– DTW çš„æœ€å¤§å€åˆ¥ã€‚
3.  **å‹•æ…‹è¦åŠƒ (DP)**ï¼š
      - ä¾åºå¡«æ»¿çŸ©é™£ï¼Œæ¯å€‹ `cost[i][j]` çš„å€¼ä»£è¡¨ `src[0...i-1]` å’Œ `trg[start...start+j-1]` ä¹‹é–“çš„æœ€ä½³å°é½Šæˆæœ¬ã€‚
      - éè¿´å¼ï¼š`dist = |src[i-1] - trg[start+j-1]|`
      - `cost[i][j] = dist + min(cost[i-1][j], cost[i][j-1], cost[i-1][j-1])`
4.  **æ‰¾å‡ºæœ€ä½³çµå°¾**ï¼š
      - åœ¨çŸ©é™£çš„ **æœ€å¾Œä¸€åˆ—** (`cost[src_len][j]`, for j from 1 to win\_len) å°‹æ‰¾æœ€å°å€¼ã€‚é€™å€‹æœ€å°å€¼å°±æ˜¯ `src` èˆ‡ `trg` ä¸­æŸå€‹å­åºåˆ—çš„æœ€ä½³åŒ¹é…æˆæœ¬ï¼Œå…¶å°æ‡‰çš„ `j` å³ç‚º `best_end`ã€‚
5.  **å›æº¯ (Backtracing)**ï¼š
      - å¾ `cost[src_len][best_end]` é–‹å§‹å¾€ `cost[0][...]` å›æº¯ï¼Œæ‰¾å‡ºæœ€ä½³è·¯å¾‘ã€‚
      - å›æº¯è·¯å¾‘åœ¨ `trg` ä¸Šçš„èµ·å§‹ç´¢å¼•ï¼Œå³ç‚º `start`ã€‚

## ğŸš€ æ•ˆèƒ½å„ªåŒ–æŠ€è¡“

æœ¬å°ˆæ¡ˆä½¿ç”¨å¤šç¨®å‰ªæ (Pruning) å’Œå•Ÿç™¼å¼ (Heuristic) ç­–ç•¥ä¾†åŠ é€Ÿæœå°‹ï¼š

  - **Sakoe-Chiba Band (`is_in_band`)**ï¼šåœ¨å¡«å¯« DP çŸ©é™£æ™‚ï¼Œåªè¨ˆç®—å°è§’ç·šå‘¨åœ `band_width` ç¯„åœå…§çš„å„²å­˜æ ¼ã€‚è‹¥ `(i, j)` åé›¢å°è§’ç·šå¤ªé ï¼Œå‰‡è·³éè¨ˆç®—ã€‚é€™é©ç”¨æ–¼é æœŸåŒ¹é…è·¯å¾‘ä¸æœƒåš´é‡æ‰­æ›²çš„æƒ…å¢ƒã€‚
  - **æˆæœ¬é–¥å€¼å‰ªæ (`config->threshold`)**ï¼šåœ¨ DP è¨ˆç®—ä¸­ï¼Œè‹¥ `curr_cost`ï¼ˆç´¯ç©æˆæœ¬ï¼‰è¶…éäº†è¨­å®šçš„ `threshold`ï¼Œå‰‡å°‡è©²æ ¼è¨­ç‚º `FLT_MAX`ï¼Œä½¿å…¶ä¸æœƒæˆç‚ºæœªä¾†è·¯å¾‘çš„ä¸€éƒ¨åˆ†ã€‚
  - **å•Ÿç™¼å¼è¦–çª—æœå°‹ (`subsequence_alignment`)**ï¼šæ¨™æº–çš„å­åºåˆ— DTW éœ€è¦ $O(m \cdot n^2)$ çš„è¤‡é›œåº¦ (m=src\_len, n=trg\_len)ã€‚æ­¤å¯¦ä½œæ¡ç”¨å•Ÿç™¼å¼æ–¹æ³•ï¼Œåƒ…æœå°‹é•·åº¦ä»‹æ–¼ `src_len` å’Œ `min(src_len * 2, trg_len)` ä¹‹é–“çš„å­åºåˆ—ï¼Œä¸¦éçª®èˆ‰æ‰€æœ‰å¯èƒ½çš„ `(start, end)` çµ„åˆã€‚
  - **ææ—©åœæ­¢ (Early Stopping)**ï¼šåœ¨ `subsequence_alignment` çš„è¦–çª—æœå°‹ä¸­ï¼Œå¦‚æœæ‰¾åˆ°ä¸€å€‹åŒ¹é…æˆæœ¬ `best_distance` å·²ç¶“ "è¶³å¤ å¥½"ï¼ˆåœ¨ç¨‹å¼ä¸­å®šç¾©ç‚º `config->threshold * 0.5`ï¼‰ï¼Œå‰‡æœƒç«‹å³åœæ­¢æœå°‹ä¸¦å›å‚³ç•¶å‰æœ€ä½³çµæœã€‚

## ğŸ› ï¸ å¦‚ä½•ç·¨è­¯èˆ‡åŸ·è¡Œ

æœ¬å°ˆæ¡ˆç¨‹å¼ç¢¼ä½¿ç”¨äº† `math.h`ï¼Œå› æ­¤åœ¨ç·¨è­¯æ™‚éœ€è¦é€£çµæ•¸å­¸å‡½å¼åº«ã€‚

1.  **ç·¨è­¯æŒ‡ä»¤**ï¼š
    æ‰“é–‹æ‚¨çš„çµ‚ç«¯æ©Ÿï¼Œä¸¦ä½¿ç”¨ `gcc` æˆ– `clang` é€²è¡Œç·¨è­¯ã€‚`-lm` æ——æ¨™æ˜¯å¿…è¦çš„ã€‚

    ```bash
    gcc main.c dtw.c -o dtw_demo -O2 -lm
    ```

2.  **åŸ·è¡Œ**ï¼š
    ç·¨è­¯æˆåŠŸå¾Œï¼Œæœƒç”Ÿæˆåç‚º `dtw_demo` çš„åŸ·è¡Œæª”ã€‚

    ```bash
    ./dtw_demo
    ```

3.  **é æœŸè¼¸å‡º**ï¼š
    åŸ·è¡Œå¾Œï¼Œæ‚¨å°‡æœƒçœ‹åˆ° `main.c` ä¸­æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹çš„çµæœã€‚

    ```
    --- TEST 1: Perfect Match (Start) ---
    Result:
      Distance:    0.0000
      Start index: 0
      End index:   2
      Path Length: 3
      Matched Subsequence (trg[0...2]):
    ----------------------------------------

    --- TEST 2: Perfect Match (End) ---
    Result:
      Distance:    0.0000
      Start index: 3
      End index:   5
      Path Length: 3
      Matched Subsequence (trg[3...5]):
    ----------------------------------------

    --- TEST 5: Threshold Pruning (Should find NULL) ---
    Result: NULL (No path found or pruned)
    ----------------------------------------

    --- TEST 11: Early Stopping (Finds first 'good enough' match) ---
    Result:
      Distance:    0.1000
      Start index: 0
      End index:   2
      Path Length: 3
      Matched Subsequence (trg[0...2]):
    ----------------------------------------

    --- TEST 12: Disabled Early Stopping (Finds global best match) ---
    Result:
      Distance:    0.0000
      Start index: 5
      End index:   7
      Path Length: 3
      Matched Subsequence (trg[5...7]):
    ----------------------------------------

    All tests completed.
    ```

## ğŸ“š API æ–‡ä»¶

### `DTWConfig`

è¨­å®š DTW æ¼”ç®—æ³•çš„å‰ªæåƒæ•¸ã€‚

```c
typedef struct {
    float sakoe_chiba_band; // çª„å¸¶å‰ªææ¯”ä¾‹ (0.0 è¡¨ç¤ºé—œé–‰)
    float threshold;        // æˆæœ¬é–¥å€¼ (0.0 è¡¨ç¤ºé—œé–‰)
} DTWConfig;
```

### `DTWResult`

å„²å­˜å­åºåˆ—å°é½Šçš„çµæœã€‚

```c
typedef struct {
    int start;        // åŒ¹é…å­åºåˆ—åœ¨ trg ä¸­çš„èµ·å§‹ç´¢å¼•
    int end;          // åŒ¹é…å­åºåˆ—åœ¨ trg ä¸­çš„çµæŸç´¢å¼•
    float distance;   // æœ€çµ‚çš„ DTW æ‰­æ›²æˆæœ¬
    int path_length;  // æœ€ä½³è·¯å¾‘çš„é•·åº¦
    int* path_i;      // æœ€ä½³è·¯å¾‘çš„ src ç´¢å¼• (éœ€æ‰‹å‹• free)
    int* path_j;      // æœ€ä½³è·¯å¾‘çš„ trg ç´¢å¼• (éœ€æ‰‹å‹• free)
} DTWResult;
```

### `DTWResult* subsequence_alignment(const float* src, size_t src_len, const float* trg, size_t trg_len, const DTWConfig* config)`

åŸ·è¡Œå­åºåˆ—å°é½Šæœå°‹ã€‚

  - **åƒæ•¸**:
      - `const float* src`: æŒ‡å‘æŸ¥è©¢åºåˆ— (çŸ­åºåˆ—) çš„æŒ‡æ¨™ã€‚
      - `size_t src_len`: æŸ¥è©¢åºåˆ—çš„é•·åº¦ã€‚
      - `const float* trg`: æŒ‡å‘ç›®æ¨™åºåˆ— (é•·åºåˆ—) çš„æŒ‡æ¨™ã€‚
      - `size_t trg_len`: ç›®æ¨™åºåˆ—çš„é•·åº¦ã€‚
      - `const DTWConfig* config`: æŒ‡å‘ DTW å‰ªæè¨­å®šçš„æŒ‡æ¨™ã€‚
  - **å›å‚³å€¼**:
      - æŒ‡å‘ `DTWResult` çµæ§‹çš„æŒ‡æ¨™ã€‚å¦‚æœæ‰¾ä¸åˆ°æœ‰æ•ˆçš„åŒ¹é…ï¼ˆä¾‹å¦‚è¢«å®Œå…¨å‰ªæï¼Œæˆ– `trg_len < src_len`ï¼‰ï¼Œå‰‡å›å‚³ `NULL`ã€‚
      - **æ³¨æ„ï¼š** å›å‚³çš„ `DTWResult` å¿…é ˆç”±å‘¼å«è€…ä½¿ç”¨ `dtw_free_result()` é‡‹æ”¾ã€‚

### `void dtw_free_result(DTWResult* result)`

é‡‹æ”¾ç”± `subsequence_alignment` åˆ†é…çš„ `DTWResult` çµæ§‹åŠå…¶å…§éƒ¨é™£åˆ—ã€‚

  - **åƒæ•¸**:
      - `DTWResult* result`: æŒ‡å‘è¦é‡‹æ”¾çš„çµæœã€‚

## ğŸ’¡ ç¯„ä¾‹è§£æ

`main.c` æª”æ¡ˆåŒ…å«äº†ä¸€ç³»åˆ—å®Œæ•´çš„æ¸¬è©¦æ¡ˆä¾‹ï¼Œç”¨æ–¼é©—è­‰ `subsequence_alignment` åœ¨ä¸åŒæƒ…å¢ƒä¸‹çš„è¡Œç‚ºï¼š

1.  **æ¡ˆä¾‹ 1, 2, 3 (åŒ¹é…æ¸¬è©¦)**ï¼š

      - æ¸¬è©¦ `src` åºåˆ—åœ¨ `trg` åºåˆ—çš„é–‹é ­ã€çµå°¾æˆ–ä¸­é–“ï¼ˆåŒ…å« warpingï¼‰æ™‚ï¼Œæ˜¯å¦éƒ½èƒ½è¢«æº–ç¢ºæ‰¾åˆ°ï¼Œä¸¦å›å‚³ `distance = 0.0`ã€‚

2.  **æ¡ˆä¾‹ 5 (Threshold Pruning)**ï¼š

      - `src = {1, 2, 3}`, `trg = {..., 1.1, 2.1, 3.1, ...}`ã€‚
      - æœ€ä½³åŒ¹é…çš„æˆæœ¬ç‚º 0.3 (0.1+0.1+0.1)ã€‚
      - è¨­å®š `config.threshold = 0.2f`ã€‚
      - ç”±æ–¼æœ€ä½³åŒ¹é… (0.3) \> é–¥å€¼ (0.2)ï¼Œè©²è·¯å¾‘åœ¨è¨ˆç®—ä¸­è¢«å‰ªæï¼Œæ¼”ç®—æ³•æœ€çµ‚æ‰¾ä¸åˆ°ä»»ä½•æœ‰æ•ˆè·¯å¾‘ï¼Œå›å‚³ `NULL`ã€‚

3.  **æ¡ˆä¾‹ 6 (Sakoe-Chiba Pruning)**ï¼š

      - `src` å’Œ `trg` ä¸­çš„åŒ¹é…é»è¢«æ‹‰å¾—å¾ˆé–‹ (e.g., `(0,2), (1,5), (2,8)`)ã€‚
      - è¨­å®šä¸€å€‹å¾ˆçª„çš„ `config.sakoe_chiba_band = 0.1f`ã€‚
      - æ¼”ç®—æ³•åœ¨æœå°‹æ™‚ï¼Œå› ç‚ºæœ€ä½³è·¯å¾‘è¶…å‡ºäº†çª„å¸¶ç¯„åœï¼Œå°è‡´æ‰¾ä¸åˆ°å¥½çš„åŒ¹é…ï¼Œå›å‚³ä¸€å€‹é«˜æˆæœ¬çš„éŒ¯èª¤åŒ¹é…æˆ– `NULL`ã€‚

4.  **æ¡ˆä¾‹ 11 vs 12 (Early Stopping)**ï¼š

      - `trg` åŒ…å«å…©å€‹åŒ¹é…ï¼šä¸€å€‹åœ¨é–‹é ­ (cost=0.1)ï¼Œä¸€å€‹åœ¨çµå°¾ (cost=0.0)ã€‚
      - **Test 11**ï¼šè¨­å®š `threshold = 0.3f`ã€‚æ¼”ç®—æ³•æœƒè§¸ç™¼ææ—©åœæ­¢æ¢ä»¶ (0.1 \< 0.3 \* 0.5)ï¼Œå› æ­¤å®ƒæœƒå›å‚³ç¬¬ä¸€å€‹æ‰¾åˆ°çš„ "å¤ å¥½" çš„åŒ¹é… (cost=0.1, start=0)ã€‚
      - **Test 12**ï¼šé—œé–‰ `threshold` (è¨­ç‚º 0.0)ã€‚æ¼”ç®—æ³•æœƒå®Œæ•´æœå°‹æ‰€æœ‰å¯èƒ½çš„è¦–çª—ï¼Œä¸¦å›å‚³å…¨åŸŸæœ€ä½³åŒ¹é… (cost=0.0, start=5)ã€‚
